<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Running an overly complicated set-up on a underpowered laptop."><title>Pinebook Pro, Manjaro with BTRFS on LUKS on NVME</title><link rel=canonical href=https://tomwis97.github.io/personal-blog/p/pinebook-pro-luks/><link rel=stylesheet href=/personal-blog/scss/style.min.86591c898bd806857815fbb8c47e8d3fed97c133b78e83d9bfc27b164dd0aa2b.css><meta property='og:title' content="Pinebook Pro, Manjaro with BTRFS on LUKS on NVME"><meta property='og:description' content="Running an overly complicated set-up on a underpowered laptop."><meta property='og:url' content='https://tomwis97.github.io/personal-blog/p/pinebook-pro-luks/'><meta property='og:site_name' content="Tom Wishaupt's Personal Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Linux'><meta property='article:tag' content='Pinebook'><meta property='article:published_time' content='2025-05-20T16:32:12+01:00'><meta property='article:modified_time' content='2025-05-20T16:32:12+01:00'><meta property='og:image' content='https://tomwis97.github.io/personal-blog/p/pinebook-pro-luks/cover.jpg'><meta name=twitter:title content="Pinebook Pro, Manjaro with BTRFS on LUKS on NVME"><meta name=twitter:description content="Running an overly complicated set-up on a underpowered laptop."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://tomwis97.github.io/personal-blog/p/pinebook-pro-luks/cover.jpg'><link rel="shortcut icon" href=/favicon.png><style>body{background-size:400px 400px}:root[data-scheme=dark] body{background-image:url(/personal-blog/images/bg-dark.svg)}:root[data-scheme=light] body{background-image:url(/personal-blog/images/bg-light.svg)}:root[data-scheme=light] aside{background-color:rgba(245,245,245,.7);backdrop-filter:blur(2px)}</style></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/personal-blog/><img src=/personal-blog/img/avatar_hu_e2dcf53b9930af42.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ðŸ’»</span></figure><div class=site-meta><h1 class=site-name><a href=/personal-blog>Tom Wishaupt's Personal Blog</a></h1><h2 class=site-description>Things I made and my interests.</h2></div></header><ol class=menu-social><li><a href=https://github.com/TomWis97 target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/personal-blog/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/personal-blog/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/personal-blog/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/personal-blog/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#steps>Steps</a></li><li><a href=#resulting-set-up>Resulting set-up</a></li><li><a href=#flashing-tow-boot-on-the-pinebook-pro>Flashing Tow-boot on the Pinebook Pro</a></li><li><a href=#create-an-sd-card-with-manjaro>Create an SD card with Manjaro</a></li><li><a href=#create-partitions-and-stuff>Create partitions and stuff</a><ol><li><a href=#create-boot>Create /boot</a></li><li><a href=#create-luks-and-btrfs>Create LUKS and btrfs</a></li></ol></li><li><a href=#mount-mount-mount>Mount, mount, mount!</a></li><li><a href=#a-lot-of-configuration>A lot of configuration</a><ol><li><a href=#gather-disk-uuids>Gather disk UUIDs</a></li><li><a href=#configure-crypttab>Configure crypttab</a></li><li><a href=#configure-fstab>Configure fstab</a></li><li><a href=#confgure-extlinux>Confgure extlinux</a></li><li><a href=#options-for-mkinitcpioconf>Options for mkinitcpio.conf</a></li></ol></li><li><a href=#done>Done!</a></li><li><a href=#bonus-pinebook-pro-uart-debugging>Bonus: Pinebook Pro UART debugging</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/personal-blog/p/pinebook-pro-luks/><img src=/personal-blog/p/pinebook-pro-luks/cover_hu_f8bc386619811e0.jpg srcset="/personal-blog/p/pinebook-pro-luks/cover_hu_f8bc386619811e0.jpg 800w, /personal-blog/p/pinebook-pro-luks/cover_hu_fe7afeb4f1760ae7.jpg 1600w" width=800 height=600 loading=lazy alt="Featured image of post Pinebook Pro, Manjaro with BTRFS on LUKS on NVME"></a></div><div class=article-details><header class=article-category><a href=/personal-blog/categories/it-projects/ style=background-color:#2a9d8f;color:#fff>IT Projects</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/personal-blog/p/pinebook-pro-luks/>Pinebook Pro, Manjaro with BTRFS on LUKS on NVME</a></h2><h3 class=article-subtitle>Running an overly complicated set-up on a underpowered laptop.</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2025-05-20T16:32:12+01:00>20 Janury 2025</time></div></footer></div></header><section class=article-content><p>So, I have this Pinebook Pro. Although a bit underpowered, still a nice and light laptop with good battery life. As it&rsquo;s an ideal candidate for a travel device, I wanted the disk to be encrypted.
However, this didn&rsquo;t turn out to be as easy as I was hoping. As it was quite a struggle with debugging over UART and a lot of cursing, I ended up writing this post.</p><p>I have standardised on Manjaro (with i3) with LUKS and Btrfs for my machines, so I also wanted this for the Pinebook Pro. I equipped my Pinebook Pro with an NVME SSD.</p><h2 id=steps>Steps</h2><p>To implement this you&rsquo;d have to do this:</p><ul><li>Flash Tow-boot to SPI (maybe optional, I don&rsquo;t even know anymore).</li><li>Create an SD card with a fresh Manjaro installation.</li><li>Create partitions, LUKS, Btrfs volumes.</li><li>Mount a fresh Manjaro image and the partitions created in the previous step.</li><li>Change some configurations.</li><li>(Bonus: UART on the Pinebook Pro.)</li></ul><h2 id=resulting-set-up>Resulting set-up</h2><p>This guide will result in the following boot sequence:</p><ul><li>The Pinebook Pro&rsquo;s CPU will read the Tow-Boot bootloader from SPI storage.</li><li>Tow-Boot will load the initial boot ramdisk (<code>/boot</code>) from the first partition of the eMMC storage.</li><li>Linux will boot and prompt for the disk encryption password.</li><li>The LUKS volume is opened and <code>/</code>, <code>/home</code> (and <code>/.snapshots</code>) Btfs volumes will be mounted.</li><li>Manjaro boots up as usual.</li></ul><h2 id=flashing-tow-boot-on-the-pinebook-pro>Flashing Tow-boot on the Pinebook Pro</h2><p>As I wanted to boot from NVME (which the Pinebook Pro does not support out of the box), I needed to flash Tow-Boot.</p><p>However, it turned out that I couldn&rsquo;t get that to work. Tow-boot read the boot partition just fine, but after loading the initial image the NVME drive would&rsquo;t show up. A missing module? Maybe. I don&rsquo;t care as I ended up placing <code>/boot</code> on the eMMC storage.</p><p>Installing Tow-Boot is quite simple, just follow <a class=link href=https://tow-boot.org/devices/pine64-pinebookPro.html target=_blank rel=noopener>the documentation</a>. You can download the Pinebook Pro version of Tow-Boot from <a class=link href=https://github.com/Tow-Boot/Tow-Boot/releases target=_blank rel=noopener>here</a>. Just make sure you grab the version for the Pinebook. <code>dd</code> it to a blank SD card and turn the Pinebook on. This should show a prompt where you can install it to the SPI storage.</p><p>Turn off the Pinebook, remove the SD card and reboot. This should show some sign of life from Tow-Boot.</p><h2 id=create-an-sd-card-with-manjaro>Create an SD card with Manjaro</h2><p>Go to the <a class=link href=https://manjaro.org/products/download/arm target=_blank rel=noopener>Manjaro ARM download page</a> and grab the <em>Generic</em> image with your preferred desktop environment. Unpack it and <code>dd</code> it to an SD card. (Something like <code>unxz Manjaro.img.xz; dd if=Manjaro.img of=/dev/yoursdcard bs=1M conv=fsync status=progress</code>.) Shove that SD in the Pinebook and boot from it. (Tow-Boot lets you easily select the boot device, which is cool.)</p><h2 id=create-partitions-and-stuff>Create partitions and stuff</h2><p>As described earlier, I&rsquo;m going to create the following partition layout:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Storage              FS             Mountpoint
</span></span><span class=line><span class=cl>eMMC (mmcblk2)
</span></span><span class=line><span class=cl>`- mmcblk2p1         FAT32          /boot
</span></span><span class=line><span class=cl>NVME (nvme0n1)
</span></span><span class=line><span class=cl>`- nvme0n1p1         LUKS container
</span></span><span class=line><span class=cl>   `- cryptroot      BTRFS          -
</span></span><span class=line><span class=cl>      |- @           BTRFS subvol   /
</span></span><span class=line><span class=cl>      |- @home       BTRFS subvol   /home
</span></span><span class=line><span class=cl>      `- @.snapshots BTRFS subvol   /.snapshots
</span></span></code></pre></td></tr></table></div></div><p>Please check if you have the same device names before copy/pasting these commands.</p><h3 id=create-boot>Create /boot</h3><ol><li>Wipe the eMMC storage.
<code># wipefs -a /dev/mmcblk2p1</code></li><li>Create a partition:</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># gdisk /dev/mmcblk2
</span></span><span class=line><span class=cl>o (create new GPT partition table)
</span></span><span class=line><span class=cl>n (create new partition)
</span></span><span class=line><span class=cl>(Partition number 1, default start, end &#34;+4G&#34;, type &#34;ef00&#34;)
</span></span><span class=line><span class=cl>w (write partition table)
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>Create a filesystem:
<code># mkfs.fat -F32 /dev/mmcblk2p1</code></li></ol><h3 id=create-luks-and-btrfs>Create LUKS and btrfs</h3><ol start=4><li>Wipe the NVME SSD:
<code># wipefs -a /dev/nvme0n1</code></li><li>Create a partition for the LUKS container.</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># gdisk /dev/nvme0n1
</span></span><span class=line><span class=cl>o (create new GPT partition table)
</span></span><span class=line><span class=cl>n (create new partition)
</span></span><span class=line><span class=cl>(Defaults for number, start and end. Type should be 8309.)
</span></span><span class=line><span class=cl>w (write partition table)
</span></span></code></pre></td></tr></table></div></div><ol start=6><li>Create a LUKS container:
<code># cryptsetup luksFormat --type=luks2 /dev/nvme0n1p1</code></li><li>Mount the LUKS container:
<code># cryptsetup open /dev/nvme0n1p1 cryptroot</code></li><li>Now the opened LUKS volume is available at /dev/mapper/cryptroot. Create the BTRFS partition:
<code># mkfs.btrfs /dev/mapper/cryptroot</code></li><li>Temporarily mount this Btrfs volume so we can create the subvolumes and unmount it again.</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># mkdir /mnt/tmp
</span></span><span class=line><span class=cl># mount /dev/mapper/cryptroot /mnt/tmp
</span></span><span class=line><span class=cl># btrfs subvolume create /mnt/tmp/@
</span></span><span class=line><span class=cl>&lt;# btrfs subvolume create /mnt/tmp/@home
</span></span><span class=line><span class=cl># btrfs subvolume create /mnt/tmp/@snapshots
</span></span><span class=line><span class=cl># unmount /mnt/tmp
</span></span></code></pre></td></tr></table></div></div><h2 id=mount-mount-mount>Mount, mount, mount!</h2><ol><li>Mount the volumes of your to-be Manjaro installation.</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># mkdir /mnt/manjaro
</span></span><span class=line><span class=cl># mount -o subvol=@ /dev/mapper/cryptroot /mnt/manjaro
</span></span><span class=line><span class=cl># mkdir /mnt/manjaro/{home,boot}
</span></span><span class=line><span class=cl># mount -o subvol=@home /dev/mapper/cryptroot /mnt/manjaro/home
</span></span><span class=line><span class=cl># mount /dev/mapper/mmcblk2p1 /mnt/manjaro/boot
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>From the Pinebook Pro, download the Manjaro pre-installed image. (Yes, again.) We are going to mount this image and use it as a source for a new installation.</li><li><code>unxz</code> the image and mount it. With losetup we can directly interact with a disk image (<code>-P</code> for discovering all partitions, <code>-r</code> for read-only and <code>-f</code> for auto detecting the available loop device).</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># mkdir -p /mnt/src/{boot,root}
</span></span><span class=line><span class=cl># losetup -Prf Manjaro_something_generic.img
</span></span><span class=line><span class=cl># mount -o ro /dev/loop0p1 /mnt/src/boot
</span></span><span class=line><span class=cl># mount -o ro /dev/loop0p2 /mnt/src/root
</span></span></code></pre></td></tr></table></div></div><ol start=4><li>Install rsync as it&rsquo;s probably not pre-installed. If this fails, you probably need to run <code>pacman -Syu</code> first.</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># pacman-mirrors
</span></span><span class=line><span class=cl># pacman -Sy rsync
</span></span></code></pre></td></tr></table></div></div><ol start=5><li>Copy files from the fresh image into your new filesystems:</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># rsync -aAXv /mnt/src/root /mnt/manjaro/
</span></span><span class=line><span class=cl># rsync -aAXv /mnt/src/boot /mnt/manjaro/boot/
</span></span></code></pre></td></tr></table></div></div><h2 id=a-lot-of-configuration>A lot of configuration</h2><p>Since the Manjaro installation we just copied isn&rsquo;t used to be encrypted and now has a different partition table, there&rsquo;s some configuration which needs to be done.</p><h3 id=gather-disk-uuids>Gather disk UUIDs</h3><p>In the following few steps, we&rsquo;re going to refer to volumes through UUIDs which we need to gather first. Please note these somewhere, we&rsquo;re going to refer to these IDs as follows:</p><div class=table-wrapper><table><thead><tr><th>Device</th><th>Name</th></tr></thead><tbody><tr><td>/dev/mmcblk2 (eMMC)</td><td>BOOT_UUID</td></tr><tr><td>/dev/nvme0n1p1</td><td>LUKS_UUID</td></tr><tr><td>/dev/mapper/cryptroot</td><td>BTRFS_UUID</td></tr></tbody></table></div><p>Per volume use the following command <code>blkid &lt;device></code> and note the value for <code>UUID=</code>. In the following steps, replace the relevant references. (I.e. change <code>UUID=&lt;LUKS_UUID></code> to <code>UUID=5ac35e05-0064-4a48-a896-56020298f90c</code>.)</p><h3 id=configure-crypttab>Configure crypttab</h3><p>Crypttab is used to unlock the luks volumes on boot. Add the following line to <code>/mnt/manjaro/etc/crypttab</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>cryptroot      UUID=&lt;LUKS_UUID&gt;                             none                    luks
</span></span></code></pre></td></tr></table></div></div><h3 id=configure-fstab>Configure fstab</h3><p>We have a lot of new partitions, so we need to update fstab. <em>Remove the two existing lines</em> (as those UUIDs don&rsquo;t exist anymore) and add the following lines to <code>/mnt/manjaro/etc/fstab</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>UUID=&lt;BTRFS_UUID&gt;      /            btrfs   subvol=@                                  0   0
</span></span><span class=line><span class=cl>UUID=&lt;BTRFS_UUID&gt;      /home        btrfs   subvol=@home                              0   0
</span></span><span class=line><span class=cl>UUID=&lt;BTRFS_UUID&gt;      /.snapshots  btrfs   subvol=@snapshots                         0   0
</span></span><span class=line><span class=cl>UUID=&lt;BOOT_UUID&gt;       /boot        vfat    defaults,noexec,umask=0077,nodev,showexec 0   0
</span></span></code></pre></td></tr></table></div></div><h3 id=confgure-extlinux>Confgure extlinux</h3><p>Extlinux needs to instruct the Linux kernel to use the newly encrypted volume. This is done by editing <code>/mnt/manjaro/boot/extlinux/extlinux.conf</code>. Replace the <code>APPEND</code> line with the following one:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>APPEND initrd=/initramfs-linux.img cryptdevice=UUID=&lt;LUKS_UUID&gt;:cryptroot root=UUID=&lt;BTRFS_UUID&gt; rootflags=subvol=@ rw rootwait audit=0 splash plymouth.ignore-serial-consoles console=ttyS2,1500000 loglevel=7 console=tty1 video=eDP-1:1920x1080@60
</span></span></code></pre></td></tr></table></div></div><p>A short explaination of the options we added:</p><ul><li><code>cryptdevice=UUID=5ac35e05-0064-4a48-a896-56020298f90c:cryptroot</code>: Instruct the kernel we have a LUKS device which should be named <code>cryptroot</code>.</li><li><code>root=UUID=84cf30ed-62dc-43b1-8882-fb0d3a88309e</code>: Refer to the BTRFS filsystem within the LUKS volume.</li><li><code>rootflags=subvol=@</code>: Instruct the kernel to use the correct subvolume for root.</li><li><code>rootwait</code>: Wait until the partition is unlocked.</li><li><code>plymouth.ignore-serial-consoles</code>: For UART debugging (so, optional).</li><li><code>console=ttyS2,1500000</code>: For UART debugging (so, optional).</li><li><code>loglevel=7</code>: For debugging (so, optional).</li><li><code>console=tty1</code>: Make sure TTY1 can be used to entering the password.</li><li><code>video=eDP-1:1920x1080@60</code>: Initialize display (might not be required, idk).</li></ul><h3 id=options-for-mkinitcpioconf>Options for mkinitcpio.conf</h3><p>The mkinitcpio creates the initial ramdisk the system uses to boot. We need to instruct it to build in the correct modules and hooks for encryption.
Within the file <code>/mnt/manjaro/etc/mkinitcpio.conf</code>, make sure the following lines are present like this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>MODULES=(panfrost rockchipdrm drm_kms_helper hantro_vpu analogix_dp rockchip_rga panel_simple arc_uart cw2015_battery i2c-hid iscsi_boot_sysfs jsm pwm_bl uhid)
</span></span><span class=line><span class=cl>HOOKS=(base udev autodetect modconf kms keyboard keymap consolefont block encrypt filesystems fsck)
</span></span><span class=line><span class=cl>COMPRESSION=&#34;cat&#34;
</span></span></code></pre></td></tr></table></div></div><p>We now need to run <code>mkinitcpio</code>. But in order to be able to do that, we need to mount some more stuff. Then chroot into your new installation and run <code>mkinitcpio -P</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># for i in proc sys dev run; do mount --bind /$i /mnt/manjaro/$i; done
</span></span><span class=line><span class=cl># chroot /mnt/manjaro
</span></span><span class=line><span class=cl># mkinitcpio -P
</span></span></code></pre></td></tr></table></div></div><h2 id=done>Done!</h2><p>This should be all. Shutdown the Pinebook Pro, <em>remove the SD card</em> and turn the laptop on again. Tow-boot should look at the eMMC device, find the boot partition, load Linux and prompt you for the encryption password.</p><h2 id=bonus-pinebook-pro-uart-debugging>Bonus: Pinebook Pro UART debugging</h2><p>When you don&rsquo;t get any display (which I encountered), it can be very helpful to see the serial console output. The Pinebook Pro provides a serial interface through the headphone jack.</p><p>I had a PL-2303HX powered USB to Serial adapter laying around which I used. I ran to the local Action store for a 3,5mm cable. I referred to <a class=link href=https://wiki.pine64.org/wiki/Pinebook_Pro#Using_the_serial_console_UART target=_blank rel=noopener>the official documentation</a> for the pinout. Please keep in mind that this is as seen from the Pinebook. So you need to connect the RX from the Pinebook Pro to the TX on the serial adapter.</p><p>Make sure that the Extlinux configuration has instructions for logging to the serial port (see above).</p><p>Also open up the Pinebook Pro and set the switch for the 3,5mm jack to UART instead of audio. Connect the 3,5mm to the Pinebook Pro and the USB adapter to another computer. On the other device, run something like picocom: <code>picocom /dev/ttyUSB0 -b 1500000</code>. As soon as the Linux kernel starts booting, you should see the output on your other computer.</p></section><footer class=article-footer><section class=article-tags><a href=/personal-blog/tags/linux/>Linux</a>
<a href=/personal-blog/tags/pinebook/>Pinebook</a></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2025 -
2026 Tom Wishaupt's Personal Blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.34.1>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/personal-blog/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>